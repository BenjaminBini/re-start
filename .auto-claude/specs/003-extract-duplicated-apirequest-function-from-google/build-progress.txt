# Build Progress: Extract duplicated apiRequest function from Google backends

## Status: In Progress

## Implementation Plan Created
- Phase 1: Create shared utility function in google-auth.ts ✓
- Phase 2: Update both backends to use shared function
- Phase 3: Verification (TypeScript build + tests)

## Subtasks
- [x] 1.1: Add apiRequest function to google-auth.ts - COMPLETED
- [x] 2.1: Update google-tasks-backend.ts to use shared apiRequest - COMPLETED
- [x] 2.2: Update google-calendar-backend.ts to use shared apiRequest - COMPLETED
- [x] 3.1: Run TypeScript compilation check - COMPLETED
- [ ] 3.2: Run tests

## Recent Changes
### 2024-12-31 - Subtask 3.1 Completed
- Ran npm run build:firefox successfully
- TypeScript compilation completed without errors
- Build output: ✓ 3792 modules transformed, ✓ built in 2.77s
- All modified files (google-auth.ts, google-tasks-backend.ts, google-calendar-backend.ts) have no type errors
- Acceptance criteria met: TypeScript compiles cleanly after refactoring
### 2024-12-31 - Subtask 2.2 Completed
- Replaced private apiRequest method in google-calendar-backend.ts with a wrapper
- Wrapper constructs full URL from baseUrl + endpoint
- Delegates to googleAuth.apiRequest<T>()
- Preserves Content-Type: application/json header
- Reduced method from 27 lines to 13 lines (simplified by 52%)
- Commit: 9af3214
### 2024-12-31 - Subtask 2.1 Completed
- Replaced private apiRequest method in google-tasks-backend.ts with a wrapper
- Wrapper constructs full URL from baseUrl + endpoint
- Delegates to googleAuth.apiRequest<T>()
- Preserves Content-Type: application/json header
- Reduced method from 23 lines to 9 lines (simplified by 60%)
- TypeScript build successful with no errors
- Commit: e99dcf9

### 2024-12-31 - Subtask 1.1 Completed
- Created generic `apiRequest<T>()` function in google-auth.ts
- Function accepts url (string) and options (RequestInit)
- Calls ensureValidToken() to get access token
- Sets Authorization: Bearer header automatically
- Handles 401 errors with descriptive message "Unauthorized: Access token is invalid or expired"
- Handles other HTTP errors with "HTTP {status}: {statusText}" format
- Returns parsed JSON typed as T
- Placed after ensureValidToken() function (line 382-402)
- Commit: 67884f5

## Notes
The two apiRequest implementations are identical - they both:
1. Get access token via ensureValidToken()
2. Make fetch request with Bearer auth header
3. Handle 401 with "Authentication expired" error
4. Handle other HTTP errors with status info
5. Return parsed JSON

Only difference: each uses its own baseUrl property.
